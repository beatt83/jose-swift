/*
 * Copyright 2024 Gon√ßalo Frade
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import JSONWebKey
@testable import JSONWebToken
import JSONWebSignature
import JSONWebEncryption
import XCTest

final class X5CValidatorTests: XCTestCase {
    
    func testValidateCertificate() throws {
        let trusted =
        """
        -----BEGIN CERTIFICATE-----
        MIICijCCAi+gAwIBAgIUQ+GZt69343+8jDCMflUIG4Il2MswCgYIKoZIzj0EAwIw
        gZkxCzAJBgNVBAYTAlVTMREwDwYDVQQIDAhOZXcgWW9yazERMA8GA1UEBwwITmV3
        IFlvcmsxDjAMBgNVBAoMBVZhcG9yMRQwEgYDVQQLDAtFbmdpbmVlcmluZzEWMBQG
        A1UEAwwNVmFwb3IgUm9vdCBDQTEmMCQGCSqGSIb3DQEJARYXYWRtaW5AdmFwb3Iu
        ZXhhbXBsZS5jb20wHhcNMjUwMTEwMDkyNzE4WhcNMzUwMTA4MDkyNzE4WjCBmTEL
        MAkGA1UEBhMCVVMxETAPBgNVBAgMCE5ldyBZb3JrMREwDwYDVQQHDAhOZXcgWW9y
        azEOMAwGA1UECgwFVmFwb3IxFDASBgNVBAsMC0VuZ2luZWVyaW5nMRYwFAYDVQQD
        DA1WYXBvciBSb290IENBMSYwJAYJKoZIhvcNAQkBFhdhZG1pbkB2YXBvci5leGFt
        cGxlLmNvbTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABK/74uVxo9bVpbF13l3d
        h7txUH20FpOwW7JsNvW6yGzRrJr0JcGIUJFUml8horg/mZLQqde+LTKf4VByWlk7
        hBKjUzBRMB0GA1UdDgQWBBTwox5TK8yr7ZDJcieuEo6hOUJvcjAfBgNVHSMEGDAW
        gBTwox5TK8yr7ZDJcieuEo6hOUJvcjAPBgNVHRMBAf8EBTADAQH/MAoGCCqGSM49
        BAMCA0kAMEYCIQDDB3s+2CUl/YrXxQUbyl38GNSpXcogYfEcWXEQmQtOlgIhAJHz
        e7CCTDHODtGan89r2VED7tXpwGk/5EWLarTvohI3
        -----END CERTIFICATE-----
        """
        
        let validToken = """
        eyJhbGciOiJFUzI1NiIsIng1YyI6WyJNSUlDZmpDQ0FpT2dBd0lCQWdJVUZ5b29aUm1zXC9TUzVKdllMMGRsNmhId1I1bFl3Q2dZSUtvWkl6ajBFQXdJd2dhRXhDekFKQmdOVkJBWVRBbFZUTVJFd0R3WURWUVFJREFoT1pYY2dXVzl5YXpFUk1BOEdBMVVFQnd3SVRtVjNJRmx2Y21zeERqQU1CZ05WQkFvTUJWWmhjRzl5TVJRd0VnWURWUVFMREF0RmJtZHBibVZsY21sdVp6RWVNQndHQTFVRUF3d1ZWbUZ3YjNJZ1NXNTBaWEp0WldScFlYUmxJRU5CTVNZd0pBWUpLb1pJaHZjTkFRa0JGaGRoWkcxcGJrQjJZWEJ2Y2k1bGVHRnRjR3hsTG1OdmJUQWVGdzB5TlRBeE1UQXdPVEkzTVRoYUZ3MHlOakF4TVRBd09USTNNVGhhTUlHV01Rc3dDUVlEVlFRR0V3SlZVekVSTUE4R0ExVUVDQXdJVG1WM0lGbHZjbXN4RVRBUEJnTlZCQWNNQ0U1bGR5QlpiM0pyTVE0d0RBWURWUVFLREFWV1lYQnZjakVVTUJJR0ExVUVDd3dMUlc1bmFXNWxaWEpwYm1jeEV6QVJCZ05WQkFNTUNsWmhjRzl5SUV4bFlXWXhKakFrQmdrcWhraUc5dzBCQ1FFV0YyRmtiV2x1UUhaaGNHOXlMbVY0WVcxd2JHVXVZMjl0TUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFWExLUHNkMVBpczE4Wno3NzlMSTNqZTRHQ1wvR0xlZUp4eFM3VjVud0Z4U0F0U3htSlhaUGx3RDZjZEZydVhkd0p2ekpuT1ByWFdENHBZdkFNUFwvN0NTNk5DTUVBd0hRWURWUjBPQkJZRUZIXC9ja0Z0bWtKYll5aXZ5VmtvdHAyRklwTnFXTUI4R0ExVWRJd1FZTUJhQUZIUFd6am43SHhHSTJ4SHhSTkVKaHkzU1JJZVZNQW9HQ0NxR1NNNDlCQU1DQTBrQU1FWUNJUURSd1g4TTZEVEgwSmVjZGNSdDBYVTdXUlhXZkZvRUZmbGRrTFJKOVU0dlFRSWhBTHBWUFhVSVozTEx2MVVTYlk3M0pRNWNrMEk3OTJjdTVcL25hQ2VUNm84ckgiLCJNSUlDampDQ0FqU2dBd0lCQWdJVVM1Uk1IUVNQOTFFWkhaRzlHTG1LcFNcL0NxYm93Q2dZSUtvWkl6ajBFQXdJd2daa3hDekFKQmdOVkJBWVRBbFZUTVJFd0R3WURWUVFJREFoT1pYY2dXVzl5YXpFUk1BOEdBMVVFQnd3SVRtVjNJRmx2Y21zeERqQU1CZ05WQkFvTUJWWmhjRzl5TVJRd0VnWURWUVFMREF0RmJtZHBibVZsY21sdVp6RVdNQlFHQTFVRUF3d05WbUZ3YjNJZ1VtOXZkQ0JEUVRFbU1DUUdDU3FHU0liM0RRRUpBUllYWVdSdGFXNUFkbUZ3YjNJdVpYaGhiWEJzWlM1amIyMHdIaGNOTWpVd01URXdNRGt5TnpFNFdoY05NekF3TVRBNU1Ea3lOekU0V2pDQm9URUxNQWtHQTFVRUJoTUNWVk14RVRBUEJnTlZCQWdNQ0U1bGR5QlpiM0pyTVJFd0R3WURWUVFIREFoT1pYY2dXVzl5YXpFT01Bd0dBMVVFQ2d3RlZtRndiM0l4RkRBU0JnTlZCQXNNQzBWdVoybHVaV1Z5YVc1bk1SNHdIQVlEVlFRRERCVldZWEJ2Y2lCSmJuUmxjbTFsWkdsaGRHVWdRMEV4SmpBa0Jna3Foa2lHOXcwQkNRRVdGMkZrYldsdVFIWmhjRzl5TG1WNFlXMXdiR1V1WTI5dE1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRXR2c1JaTmFvWXhlME9FY3lTcDRQanQxWjF4NmJ2VVwvYU5PVVdjazVpZEJpWHpMZnExYXREaGpsNVpSUEFOSWozeXI3aGw0clNrZ3FramFiQXJLY250S05RTUU0d0RBWURWUjBUQkFVd0F3RUJcL3pBZEJnTlZIUTRFRmdRVWM5Yk9PZnNmRVlqYkVmRkUwUW1ITGRKRWg1VXdId1lEVlIwakJCZ3dGb0FVOEtNZVV5dk1xKzJReVhJbnJoS09vVGxDYjNJd0NnWUlLb1pJemowRUF3SURTQUF3UlFJaEFOVFFaVGxvdCtQSGk5a2NzbHl1ZHdqSXFaNTdVbms2VXdwVHJ4Wm40bXQxQWlBd3poaW5jUHNvSE5FWnIrdEFFZmtOb0crMzVGVG9jbElxV0F4aVErMnpNdz09IiwiTUlJQ2lqQ0NBaStnQXdJQkFnSVVRK0dadDY5MzQzKzhqRENNZmxVSUc0SWwyTXN3Q2dZSUtvWkl6ajBFQXdJd2daa3hDekFKQmdOVkJBWVRBbFZUTVJFd0R3WURWUVFJREFoT1pYY2dXVzl5YXpFUk1BOEdBMVVFQnd3SVRtVjNJRmx2Y21zeERqQU1CZ05WQkFvTUJWWmhjRzl5TVJRd0VnWURWUVFMREF0RmJtZHBibVZsY21sdVp6RVdNQlFHQTFVRUF3d05WbUZ3YjNJZ1VtOXZkQ0JEUVRFbU1DUUdDU3FHU0liM0RRRUpBUllYWVdSdGFXNUFkbUZ3YjNJdVpYaGhiWEJzWlM1amIyMHdIaGNOTWpVd01URXdNRGt5TnpFNFdoY05NelV3TVRBNE1Ea3lOekU0V2pDQm1URUxNQWtHQTFVRUJoTUNWVk14RVRBUEJnTlZCQWdNQ0U1bGR5QlpiM0pyTVJFd0R3WURWUVFIREFoT1pYY2dXVzl5YXpFT01Bd0dBMVVFQ2d3RlZtRndiM0l4RkRBU0JnTlZCQXNNQzBWdVoybHVaV1Z5YVc1bk1SWXdGQVlEVlFRRERBMVdZWEJ2Y2lCU2IyOTBJRU5CTVNZd0pBWUpLb1pJaHZjTkFRa0JGaGRoWkcxcGJrQjJZWEJ2Y2k1bGVHRnRjR3hsTG1OdmJUQlpNQk1HQnlxR1NNNDlBZ0VHQ0NxR1NNNDlBd0VIQTBJQUJLXC83NHVWeG85YlZwYkYxM2wzZGg3dHhVSDIwRnBPd1c3SnNOdlc2eUd6UnJKcjBKY0dJVUpGVW1sOGhvcmdcL21aTFFxZGUrTFRLZjRWQnlXbGs3aEJLalV6QlJNQjBHQTFVZERnUVdCQlR3b3g1VEs4eXI3WkRKY2lldUVvNmhPVUp2Y2pBZkJnTlZIU01FR0RBV2dCVHdveDVUSzh5cjdaREpjaWV1RW82aE9VSnZjakFQQmdOVkhSTUJBZjhFQlRBREFRSFwvTUFvR0NDcUdTTTQ5QkFNQ0Ewa0FNRVlDSVFEREIzcysyQ1VsXC9Zclh4UVVieWwzOEdOU3BYY29nWWZFY1dYRVFtUXRPbGdJaEFKSHplN0NDVERIT0R0R2FuODlyMlZFRDd0WHB3R2tcLzVFV0xhclR2b2hJMyJdLCJ0eXAiOiJKV1QifQ.eyJjb29sIjp0cnVlfQ.RzvCDMflF974cTCZmUkImLxYJHMTmfnCShCmvf-B38Bc4sL3POrTY-YPCDq7_ENudUKJP9WDQ-6Gn1PcjmXfaQ
        """
        let validator = try X5CValidator(rootCertificates: [trusted])
        XCTAssertNoThrow(try validator.isValid(validToken))
    }
}
